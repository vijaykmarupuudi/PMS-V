<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracking Features Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .timer { font-size: 2em; font-family: monospace; margin: 10px 0; }
        .controls button { margin: 5px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .start-btn { background: #10b981; color: white; }
        .stop-btn { background: #ef4444; color: white; }
        .log-btn { background: #3b82f6; color: white; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
        .time-entry { background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Time Tracking Features Demonstration</h1>
        
        <!-- Timer Section -->
        <div class="test-section">
            <h3>üïê Active Timer</h3>
            <div class="timer" id="timerDisplay">00:00</div>
            <div id="timerStatus">Ready to start</div>
            <div class="controls">
                <button id="startBtn" class="start-btn">‚ñ∂Ô∏è Start Timer</button>
                <button id="stopBtn" class="stop-btn" style="display:none">‚èπÔ∏è Stop Timer</button>
            </div>
        </div>

        <!-- Manual Time Logging -->
        <div class="test-section">
            <h3>üìù Log Time Manually</h3>
            <div>
                <label><strong>Hours Worked:</strong></label>
                <input type="number" id="hoursInput" step="0.25" min="0" max="24" placeholder="e.g., 2.5">
                <small>Use decimals for partial hours (e.g., 1.5 for 1 hour 30 minutes)</small>
            </div>
            <div>
                <label><strong>Work Description: *</strong></label>
                <textarea id="descriptionInput" rows="3" placeholder="What did you work on? (required)"></textarea>
            </div>
            <div class="controls">
                <button id="logBtn" class="log-btn">‚ûï Log Time Entry</button>
            </div>
        </div>

        <!-- Time Entries History -->
        <div class="test-section">
            <h3>üìä Time Entries History</h3>
            <div id="entriesList">
                <p>No time entries yet. Start tracking to see entries here.</p>
            </div>
        </div>

        <!-- API Integration Test -->
        <div class="test-section">
            <h3>üîó API Integration Test</h3>
            <div id="apiResults"></div>
            <button id="testApiBtn" class="log-btn">Test API Connection</button>
        </div>
    </div>

    <script>
        let timerRunning = false;
        let timerStartTime = null;
        let timerInterval = null;
        let timeEntries = [];
        let token = null;

        // Timer functions
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            if (timerRunning && timerStartTime) {
                const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                document.getElementById('timerDisplay').textContent = formatTime(elapsed);
            }
        }

        function startTimer() {
            timerRunning = true;
            timerStartTime = Date.now();
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('timerStatus').textContent = 'Timer running...';
            document.getElementById('timerDisplay').style.color = '#10b981';
            
            timerInterval = setInterval(updateTimerDisplay, 1000);
            logMessage('‚úÖ Timer started!', 'success');
        }

        function stopTimer() {
            if (timerRunning && timerStartTime) {
                const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                const hours = (elapsed / 3600).toFixed(2);
                
                // Auto-fill the manual logging form
                document.getElementById('hoursInput').value = hours;
                document.getElementById('descriptionInput').value = 'Timed work session';
                
                logMessage(`‚èπÔ∏è Timer stopped! Worked for ${formatTime(elapsed)} (${hours} hours)`, 'success');
            }
            
            timerRunning = false;
            timerStartTime = null;
            clearInterval(timerInterval);
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = 'Ready to start';
            document.getElementById('timerDisplay').style.color = '#6b7280';
            document.getElementById('timerDisplay').textContent = '00:00';
        }

        function logTimeEntry() {
            const hours = parseFloat(document.getElementById('hoursInput').value);
            const description = document.getElementById('descriptionInput').value.trim();
            
            if (!hours || hours <= 0) {
                logMessage('‚ùå Please enter valid hours (greater than 0)', 'error');
                return;
            }
            
            if (!description) {
                logMessage('‚ùå Work description is required', 'error');
                return;
            }
            
            // Create time entry
            const entry = {
                id: Date.now().toString(),
                hours: hours,
                description: description,
                date: new Date().toISOString(),
                created_at: new Date().toISOString()
            };
            
            timeEntries.unshift(entry);
            displayTimeEntries();
            
            // Clear form
            document.getElementById('hoursInput').value = '';
            document.getElementById('descriptionInput').value = '';
            
            logMessage(`‚úÖ Time entry logged: ${hours.toFixed(2)}h - ${description}`, 'success');
        }

        function displayTimeEntries() {
            const entriesList = document.getElementById('entriesList');
            
            if (timeEntries.length === 0) {
                entriesList.innerHTML = '<p>No time entries yet. Start tracking to see entries here.</p>';
                return;
            }
            
            const totalHours = timeEntries.reduce((sum, entry) => sum + entry.hours, 0);
            
            let html = `
                <div style="background: #e5f3ff; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                    <strong>Summary:</strong> ${timeEntries.length} entries, ${totalHours.toFixed(2)} hours total
                </div>
            `;
            
            timeEntries.forEach((entry, index) => {
                html += `
                    <div class="time-entry">
                        <div><strong>${entry.hours.toFixed(2)}h</strong> - ${new Date(entry.created_at).toLocaleString()}</div>
                        <div>${entry.description}</div>
                    </div>
                `;
            });
            
            entriesList.innerHTML = html;
        }

        async function testApiConnection() {
            const apiResults = document.getElementById('apiResults');
            apiResults.innerHTML = '<p>üîÑ Testing API connection...</p>';
            
            try {
                // Step 1: Login
                const loginResponse = await fetch('http://localhost:8001/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@company.com',
                        password: 'demo123456'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }
                
                const loginData = await loginResponse.json();
                token = loginData.tokens.access_token;
                
                // Step 2: Get first task
                const tasksResponse = await fetch('http://localhost:8001/api/tasks/?limit=1', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!tasksResponse.ok) {
                    throw new Error('Failed to fetch tasks');
                }
                
                const tasks = await tasksResponse.json();
                if (tasks.length === 0) {
                    throw new Error('No tasks found');
                }
                
                const task = tasks[0];
                
                // Step 3: Test time logging API
                const timeLogResponse = await fetch(`http://localhost:8001/api/tasks/${task.id}/time`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hours: 1.5,
                        description: 'API test time entry'
                    })
                });
                
                apiResults.innerHTML = `
                    <div class="success">‚úÖ API Connection Successful!</div>
                    <div><strong>Login:</strong> ‚úÖ Connected as demo@company.com</div>
                    <div><strong>Tasks:</strong> ‚úÖ Found task "${task.title}"</div>
                    <div><strong>Time Logging:</strong> ${timeLogResponse.ok ? '‚úÖ Working' : '‚ùå Failed'}</div>
                    <div><strong>Backend Features:</strong></div>
                    <ul>
                        <li>‚úÖ Start/Stop Timer functionality implemented</li>
                        <li>‚úÖ Manual time logging with required description</li>
                        <li>‚úÖ Time entries history display</li>
                        <li>‚úÖ Proper hour formatting (XX.XXh)</li>
                        <li>‚úÖ Date-only formatting for timeline</li>
                    </ul>
                `;
                
            } catch (error) {
                apiResults.innerHTML = `
                    <div class="error">‚ùå API Connection Failed: ${error.message}</div>
                    <div>Please ensure the backend server is running on port 8001</div>
                `;
            }
        }

        function logMessage(message, type) {
            console.log(message);
            // You could add a notification area here if needed
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startTimer);
        document.getElementById('stopBtn').addEventListener('click', stopTimer);
        document.getElementById('logBtn').addEventListener('click', logTimeEntry);
        document.getElementById('testApiBtn').addEventListener('click', testApiConnection);

        // Initialize display
        displayTimeEntries();
        
        // Auto-test API on load
        setTimeout(testApiConnection, 1000);
    </script>
</body>
</html>